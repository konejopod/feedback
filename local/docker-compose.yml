version: '3.5'

services:

  # mongodb
  mongodb:
    image: mongo:4.2.0
    container_name: fb_mongodb
    user: "${USERID}:${GROUPID}"
    env_file: 
      - ../api/.env-local
    ports:
      - "27017:27017"
    volumes:
      - ./mongo/data:/data/db:rw
    restart: unless-stopped
    networks:
      - fb_network
    # Image does not contain curl
    # healthcheck:
    #   test: ["CMD", "curl", "-f", "http://localhost:27017"]
    #   interval: 5s
    #   timeout: 10s
    #   retries: 3

  # api app    
  api:
    image: fb_api/local
    build:
      context: .
      dockerfile: nodejs-app.dockerfile
      args:
        APP_PORT: 5100
    container_name: fb_api
    user: "${USERID}:${GROUPID}"
    env_file: 
      - ../api/.env-local
    depends_on:
      - mongodb
    ports:
      - "5100:5100"
    volumes:
      - ../api:/app:rw
    restart: unless-stopped
    networks:
      - fb_network

  # view app
  view:
    image: fb_view/local
    build:
      context: .
      dockerfile: nodejs-app.dockerfile
      args:
        APP_PORT: 3000
    container_name: fb_view
    user: "${USERID}:${GROUPID}"
    env_file: 
      - ../view/.env-local
    depends_on:
      - api
    ports:
      - "3000:3000"
    volumes:
      - ../view:/app:rw
    restart: unless-stopped
    networks:
      - fb_network
  
  # nginx
  nginx:
    image: nginx:1.17.4
    container_name: fb_nginx
    #user: "${USERID}:${GROUPID}" # We need access to /etc/nginx/conf.d
    depends_on:
      - api
      - view
    ports:
      - "80:80"
    volumes:
      - ./nginx/config/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    restart: unless-stopped
    networks:
      - fb_network

networks: 
  fb_network:
